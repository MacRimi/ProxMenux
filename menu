#!/bin/bash

# ==========================================================
# ProxMenux - A menu-driven script for Proxmox VE management
# ==========================================================
# Author      : MacRimi
# Copyright   : (c) 2024 MacRimi
# License     : (CC BY-NC 4.0) (https://github.com/MacRimi/ProxMenux/blob/main/LICENSE)
# Version     : 1.1
# Last Updated: 04/07/2025
# ==========================================================
# Description:
# This script serves as the main entry point for ProxMenux,
# a menu-driven tool designed for Proxmox VE management.
#
# - Displays the ProxMenux logo on startup.
# - Loads necessary configurations and language settings.
# - Checks for available updates and installs them if confirmed.
# - Downloads and executes the latest main menu script.
#
# Key Features:
# - Ensures ProxMenux is always up-to-date by fetching the latest version.
# - Uses whiptail for interactive menus and language selection.
# - Loads utility functions and translation support.
# - Maintains a cache system to improve performance.
# - Executes the ProxMenux main menu dynamically from the repository.
#
# This script ensures a streamlined and automated experience
# for managing Proxmox VE using ProxMenux.
# ==========================================================

# Configuration ============================================
REPO_URL="https://raw.githubusercontent.com/MacRimi/ProxMenux/main"
BASE_DIR="/usr/local/share/proxmenux"
LOCAL_SCRIPTS="$BASE_DIR/scripts" 
CONFIG_FILE="$BASE_DIR/config.json"
CACHE_FILE="$BASE_DIR/cache.json"
UTILS_FILE="$BASE_DIR/utils.sh"
LOCAL_VERSION_FILE="$BASE_DIR/version.txt"
VENV_PATH="/opt/googletrans-env"

if [[ -f "$UTILS_FILE" ]]; then
    source "$UTILS_FILE"
fi
#: "${LOCAL_SCRIPTS:=/usr/local/share/proxmenux/scripts}"

# =========================================================

check_updates() {
    local INSTALL_SCRIPT="$BASE_DIR/install_proxmenux.sh"
    local VERSION_URL="$REPO_URL/version.txt"
    local INSTALL_URL="$REPO_URL/install_proxmenux.sh"

    local CURL_OPTS=(
        -fsSL
        --connect-timeout 3
        --max-time 5
    )

    local REMOTE_VERSION
    REMOTE_VERSION="$(curl "${CURL_OPTS[@]}" "$VERSION_URL" 2>/dev/null | head -n 1 || true)"

    if [ -z "$REMOTE_VERSION" ]; then
        return 0
    fi

    local LOCAL_VERSION=""
    if [ -f "$LOCAL_VERSION_FILE" ]; then
        LOCAL_VERSION="$(head -n 1 "$LOCAL_VERSION_FILE" 2>/dev/null || true)"
    fi

    [ "$LOCAL_VERSION" = "$REMOTE_VERSION" ] && return 0

    if whiptail --title "$(translate 'Update Available')" \
                --yesno "$(translate 'New version available') ($REMOTE_VERSION)\n\n$(translate 'Do you want to update now?')" \
                10 60 --defaultno; then

        msg_warn "$(translate 'Starting ProxMenux update...')"

        if curl "${CURL_OPTS[@]}" "$INSTALL_URL" -o "$INSTALL_SCRIPT"; then
            chmod +x "$INSTALL_SCRIPT"


            if bash "$INSTALL_SCRIPT" --update >/tmp/proxmenux-install.log 2>&1; then
                exec "$0"   
            else
                return 0  
            fi
        else
            msg_warn "$(translate 'Unable to download the installer. Please try again later.')"
        fi

    else
        msg_warn "$(translate 'Update postponed. You can update later from the menu.')"
    fi
}

main_menu() {
    exec bash "$LOCAL_SCRIPTS/menus/main_menu.sh"
}

load_language
initialize_cache
check_updates
main_menu
